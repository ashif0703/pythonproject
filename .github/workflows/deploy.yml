name: Deploy Flask App to EC2

on:
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: ðŸ“¥ Checkout code
      uses: actions/checkout@v3

    - name: ðŸ§¹ Clean up old folder on EC2
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 15.206.100.195
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "Stopping running app (if any)..."
          pkill -f app.py || echo "No app running"

          echo "Cleaning old app folder..."
          rm -rf ~/my-flask-app
          mkdir -p ~/my-flask-app
          echo "App folder ready."

    - name: ðŸ“¤ Upload project to EC2
      uses: appleboy/scp-action@v0.1.4
      with:
        host: 15.206.100.195
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        source: "."
        target: "~/my-flask-app"

    - name: ðŸ Set up Python venv & install dependencies
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 15.206.100.195
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "Navigating to app folder..."
          cd ~/my-flask-app

          echo "Setting up virtual environment..."
          python3 -m venv venv

          echo "Activating venv..."
          source venv/bin/activate

          echo "Installing requirements..."
          pip install --upgrade pip
          pip install -r requirements.txt

    - name: ðŸš€ Run Flask app in background
      uses: appleboy/ssh-action@v1.0.0
      with:
        host: 15.206.100.195
        username: ubuntu
        key: ${{ secrets.EC2_KEY }}
        script: |
          echo "Navigating to app directory..."
          cd ~/my-flask-app

          echo "Activating venv and launching Flask app..."
          source venv/bin/activate
          nohup python3 app.py > app.log 2>&1 &
          echo "Flask app started."

